# 001. 三层架构设计

**日期**：2025-11-02
**状态**：已接受

## 背景

Univers 要构建一个 AIoT 物联网平台，支持多个垂直行业（HVAC、照明、电梯等）的智能化管理。

我们面临的核心挑战：
1. **如何让 AI 和人类高效协作**，而非简单的"AI 替代人"
2. **如何支持多个行业**，避免每个行业都重复开发基础能力
3. **如何让 AI 易于调用基础能力**，而不需要理解复杂的底层实现
4. **如何平衡自动化和人类控制**，建立用户对 AI 的信任

## 决策

我们采用**三层架构**：

```
┌─────────────────────────────────────────┐
│  Workbench (工作台 - 平台层)              │
│  - 通用 AIoT 基础设施                    │
│  - 人机协作界面                          │
│  - 设备管理、数据存储、权限系统           │
└─────────────┬───────────────────────────┘
              │ 暴露能力
              ↓
┌─────────────────────────────────────────┐
│  Skills (技能 - 能力层)                   │
│  - 封装 workbench 能力为标准化 API       │
│  - AI 调用 workbench 的桥梁              │
│  - 类似 Claude Code 的 skills 机制       │
└─────────────┬───────────────────────────┘
              │ 提供能力
              ↓
┌─────────────────────────────────────────┐
│  Operation (执行 - 应用层)                │
│  - 行业特定的业务逻辑 (如 hvac-operation) │
│  - AI 自动化执行                         │
│  - 通过 skills 使用基础能力               │
└─────────────────────────────────────────┘
```

### 各层职责

#### Workbench (平台层)
**定位**：通用 AIoT 基础设施 + 人机协作工作台

**核心能力**：
- 设备连接和管理（MQTT、HTTP、CoAP 等协议）
- 时序数据存储和查询
- 用户权限和租户管理
- 实时监控大屏
- AI 协作界面（目标设定、策略审批、异常告警）

**特点**：
- **行业无关**：可用于任何 IoT 场景
- **人类友好**：让非技术用户能轻松设定目标
- **开放集成**：可集成第三方服务

#### Skills (能力层)
**定位**：AI 与 workbench 的连接桥梁

**核心能力**：
- 把 workbench 的底层能力封装成**易用的 API**
- 提供标准化的接口规范
- 让 AI 不需要理解 workbench 实现细节

**示例**：
```python
# Skill: 设备控制
skill.device.control(device_id="hvac-01", action="set_temp", value=22)

# Skill: 数据查询
data = skill.data.query(sensor="temp-sensor-3f", time_range="last_24h")

# Skill: 告警通知
skill.alert.send(level="warning", message="3楼温度异常")
```

**特点**：
- **AI 友好**：清晰的 API，AI 容易理解和调用
- **可扩展**：可持续增加新的 skills
- **版本管理**：skills 可独立升级

#### Operation (应用层)
**定位**：行业特定的业务实现

**核心能力**（以 hvac-operation 为例）：
- HVAC 设备的控制逻辑
- 能效优化算法
- 故障诊断规则
- 预测性维护
- AI 自动化任务

**特点**：
- **行业专精**：深度理解 HVAC 业务
- **AI 驱动**：大量自动化决策
- **通过 skills 调用能力**：不直接访问 workbench

## 决策原因

### 1. 符合核心哲学

这个架构完美体现了我们的[核心哲学](../PHILOSOPHY.md)：

- **Workbench = 人类层**：人类在这里设定目标、监督 AI、处理异常
- **Operation = AI 层**：AI 在这里自动执行、实时优化
- **Skills = 连接层**：让人机协作高效流畅

### 2. 解耦和复用

- Workbench 可以支持**多个行业**（hvac、lighting、elevator）
- 每个行业只需开发自己的 operation 层
- Skills 在多个 operation 间**复用**，降低成本

### 3. AI 友好

- Skills 提供清晰的 API，AI 容易理解
- Operation 中的 AI 不需要理解复杂的基础设施
- 类似 Claude Code 的 skills 机制，已被证明有效

### 4. 演进灵活

- Workbench 升级不影响 operation
- 可以逐步增加新的 skills
- Operation 可以选择性使用 skills
- 可以逐步提升 operation 的自主程度

## 后果

### 正面影响

✅ **清晰的职责边界**
- 每层专注于自己的事情
- 便于团队分工和协作

✅ **快速支持新行业**
- Workbench 和 skills 复用
- 只需开发行业特定的 operation

✅ **建立信任**
- 人类通过 workbench 始终掌控
- AI 的行为可追溯、可干预

✅ **商业价值**
- Workbench: 平台能力，可授权
- Skills: 生态建设，可开放
- Operation: 行业 know-how，核心竞争力

### 负面影响

⚠️ **增加复杂度**
- 三层而非单体，理解成本更高
- 需要设计好层间接口

**缓解措施**：
- 清晰的文档和培训
- 统一的 skills 规范

⚠️ **可能过度设计**
- 如果只做一个行业，三层可能太重
- Skills 层可能成为"中间商"

**缓解措施**：
- 我们明确要支持多行业，所以值得
- Skills 不只是"转发"，还有标准化和版本管理价值

⚠️ **性能损耗**
- 多一层调用，可能增加延迟

**缓解措施**：
- Skills 是轻量级封装，性能影响小
- 关键路径可以优化

### 风险

🔴 **Skills 设计不当**
- 如果 skills API 设计不合理，会影响整个系统
- **应对**：先做 HVAC，积累经验后再抽象通用 skills

🔴 **AI 能力不足**
- 如果 AI 理解不了 skills，整个架构失效
- **应对**：skills 设计要简单清晰，配合充分的文档和示例

## 替代方案

### 方案 A：单体架构

**描述**：把所有功能做在一个系统里

**优点**：
- 简单直接
- 开发速度快

**缺点**：
- 不同行业耦合在一起
- 难以复用
- 难以扩展

**为什么不选**：与我们支持多行业的目标冲突

### 方案 B：两层架构（平台 + 应用）

**描述**：只有 workbench 和 operation，没有 skills

**优点**：
- 比三层简单
- 少一层调用

**缺点**：
- Operation 直接调用 workbench，AI 需要理解复杂的底层 API
- 缺少标准化层，难以管理能力演进

**为什么不选**：不够 AI 友好，不符合我们的人机协作哲学

### 方案 C：微服务架构

**描述**：拆分成多个独立的微服务

**优点**：
- 最大化解耦
- 可独立部署

**缺点**：
- 复杂度极高
- 运维成本大
- 对小团队不友好

**为什么不选**：过度设计，现阶段不需要

## 对组织的影响

### 技术团队

- **平台团队**：负责 workbench 开发和维护
- **Skills 团队**：设计和维护 skills API
- **行业团队**：开发各个行业的 operation（HVAC、照明等）

### 产品设计

- **Workbench 产品经理**：关注人机协作体验
- **行业产品经理**：关注行业特定需求

### 商业策略

- **平台授权**：可以授权第三方使用 workbench
- **生态建设**：开放 skills，让合作伙伴开发新能力
- **行业深耕**：通过 operation 建立行业壁垒

## 成功指标

如何判断这个架构是成功的？

1. **新行业上线速度**：支持一个新行业 < 3 个月
2. **能力复用率**：新行业 > 70% 的能力来自 workbench 和 skills
3. **AI 调用成功率**：AI 调用 skills 成功率 > 95%
4. **用户信任度**：用户愿意让 AI 自动执行的比例持续提升

## 参考资料

- [Univers 核心哲学](../PHILOSOPHY.md)
- [系统架构详细说明](../tech/architecture.md)
- [产品设计原则](../product/design-principles.md)
- Claude Code Skills 机制

---

**维护者**：架构团队
**审批者**：CTO, CEO
**实施时间**：2024 Q4 开始

> 这是 Univers 最重要的架构决策。所有系统设计都基于此。
